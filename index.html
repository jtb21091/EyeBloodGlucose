<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EyeBloodGlucose – Live Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background-color: #f5f5f5; }
    #panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    
    .left-column {
      display: flex;
      flex-direction: column;
    }
    
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    #videoContainer { 
      position: relative; 
      width: 100%; 
      max-width: 640px; 
      aspect-ratio: 4/3;
      background: #000;
    }
    video { 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      width: 100%; 
      height: 100%;
      display: block;
    }
    #overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none;
    }
    button { padding: 8px 12px; margin-top: 10px; }
    .glucose-normal { color: #22c55e; font-weight: bold; }
    .glucose-abnormal { color: #ef4444; font-weight: bold; }
    #status { 
      padding: 8px 12px; 
      border-radius: 6px; 
      margin-top: 8px;
      font-size: 14px;
    }
    .status-normal { 
      background-color: #dcfce7; 
      color: #166534;
      border: 2px solid #22c55e;
    }
    .status-abnormal { 
      background-color: #fee2e2; 
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    canvas { display: none; }
    
    .glucose-box {
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: white;
    }
    
    .chart-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .chart-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    .chart-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-download {
      padding: 8px 16px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .btn-download:hover {
      background-color: #1976D2;
    }
    .btn-clear {
      padding: 8px 16px;
      background-color: #9E9E9E;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .btn-clear:hover {
      background-color: #757575;
    }
    #chartCanvas {
      display: block !important;
      max-height: 300px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .stat-box {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
    }
    
    @media (max-width: 1024px) {
      #panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h2>EyeBloodGlucose – Real-Time Demo</h2>
  <p>Real-time webcam prototype with live eye detection – not medical advice. <strong>Both eyes required for prediction.</strong></p>

  <div id="panel">
    <div class="left-column">
      <div id="videoContainer">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
      <button id="start">Start</button>
      <button id="stop" disabled>Stop</button>
      <div style="margin-top:8px;color:#666">Strict mode: Both eyes must be open</div>
    </div>

    <div class="right-column">
      <div class="glucose-box">
        <div><strong>Predicted glucose:</strong></div>
        <div id="out" style="font-size:32px;margin-top:6px">—</div>
        <div id="status" style="display:none;"></div>
        <div id="msg" style="font-size:12px;color:#666;margin-top:6px"></div>
      </div>
      
      <div class="chart-section">
        <div class="chart-header">
          <h3 class="chart-title">Glucose History</h3>
          <div class="chart-buttons">
            <button id="downloadBtn" class="btn-download">Download CSV</button>
            <button id="clearBtn" class="btn-clear">Clear History</button>
          </div>
        </div>
        <canvas id="chartCanvas"></canvas>
        
        <div class="stats">
          <div class="stat-box">
            <div class="stat-label">Average</div>
            <div class="stat-value" id="avgGlucose">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Highest</div>
            <div class="stat-value" id="maxGlucose">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Lowest</div>
            <div class="stat-value" id="minGlucose">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Readings</div>
            <div class="stat-value" id="readingCount">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<canvas id="capture" width="224" height="224"></canvas>

<script>
const API = "https://eyebloodglucose.onrender.com/predict";
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
const capture = document.getElementById('capture');
const captureCtx = capture.getContext('2d');
const out = document.getElementById('out');
const msg = document.getElementById('msg');
const status = document.getElementById('status');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');

let timer = null;
let currentGlucose = null;
let currentEyes = [];

let glucoseData = [];
let chart = null;

// Sync canvas size with video display size
function resizeCanvas() {
  const rect = video.getBoundingClientRect();
  overlay.width = rect.width;
  overlay.height = rect.height;
}

// Call resize when video metadata loads and on window resize
video.addEventListener('loadedmetadata', resizeCanvas);
window.addEventListener('resize', resizeCanvas);

function initChart() {
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Glucose Level (mg/dL)',
          data: [],
          borderColor: '#2196F3',
          backgroundColor: 'rgba(33, 150, 243, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Normal Upper (140 mg/dL)',
          data: [],
          borderColor: '#22c55e',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        },
        {
          label: 'Normal Lower (70 mg/dL)',
          data: [],
          borderColor: '#FF9800',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: { size: 11 },
            boxWidth: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              if (context.datasetIndex === 0) {
                return 'Glucose: ' + context.parsed.y.toFixed(1) + ' mg/dL';
              }
              return context.dataset.label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 50,
          max: 250,
          title: {
            display: true,
            text: 'Glucose (mg/dL)',
            font: { size: 11 }
          },
          ticks: {
            font: { size: 10 }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Time',
            font: { size: 11 }
          },
          ticks: {
            font: { size: 10 },
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function addGlucoseReading(value) {
  const now = new Date();
  const timeString = now.toLocaleTimeString();
  
  glucoseData.push({
    time: timeString,
    value: value,
    timestamp: now
  });
  
  if (glucoseData.length > 50) {
    glucoseData.shift();
  }
  
  updateChart();
  updateStats();
}

function updateChart() {
  chart.data.labels = glucoseData.map(d => d.time);
  chart.data.datasets[0].data = glucoseData.map(d => d.value);
  chart.data.datasets[1].data = new Array(glucoseData.length).fill(140);
  chart.data.datasets[2].data = new Array(glucoseData.length).fill(70);
  chart.update('none');
}

function updateStats() {
  if (glucoseData.length === 0) return;
  
  const values = glucoseData.map(d => d.value);
  const avg = values.reduce((a, b) => a + b, 0) / values.length;
  const max = Math.max(...values);
  const min = Math.min(...values);
  
  document.getElementById('avgGlucose').textContent = avg.toFixed(1);
  document.getElementById('maxGlucose').textContent = max.toFixed(1);
  document.getElementById('minGlucose').textContent = min.toFixed(1);
  document.getElementById('readingCount').textContent = glucoseData.length;
}

function downloadCSV() {
  if (glucoseData.length === 0) {
    alert('No data to download yet!');
    return;
  }
  
  let csvContent = "Time,Glucose (mg/dL),Timestamp\n";
  glucoseData.forEach(reading => {
    csvContent += `${reading.time},${reading.value.toFixed(1)},${reading.timestamp.toISOString()}\n`;
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  const dateStr = new Date().toISOString().split('T')[0];
  link.setAttribute('href', url);
  link.setAttribute('download', `glucose_readings_${dateStr}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

document.getElementById('clearBtn').addEventListener('click', () => {
  if (confirm('Clear all glucose history?')) {
    glucoseData = [];
    updateChart();
    updateStats();
    document.getElementById('avgGlucose').textContent = '--';
    document.getElementById('maxGlucose').textContent = '--';
    document.getElementById('minGlucose').textContent = '--';
    document.getElementById('readingCount').textContent = '0';
  }
});

function drawEyeBoxes() {
  overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  
  if (currentEyes.length === 2) {
    // Calculate scaling factors
    const scaleX = overlay.width / 640;
    const scaleY = overlay.height / 480;
    
    // Draw green boxes around detected eyes
    overlayCtx.strokeStyle = '#00ff00';
    overlayCtx.lineWidth = 3;
    overlayCtx.fillStyle = '#00ff00';
    
    currentEyes.forEach(eye => {
      // Scale coordinates to match actual canvas size
      const x = eye.x * scaleX;
      const y = eye.y * scaleY;
      const w = eye.w * scaleX;
      const h = eye.h * scaleY;
      
      const cx = x + w / 2;
      const cy = y + h / 2;
      
      // Rectangle
      overlayCtx.strokeRect(x, y, w, h);
      
      // Crosshair
      overlayCtx.beginPath();
      overlayCtx.moveTo(cx - 12, cy);
      overlayCtx.lineTo(cx + 12, cy);
      overlayCtx.moveTo(cx, cy - 12);
      overlayCtx.lineTo(cx, cy + 12);
      overlayCtx.stroke();
      
      // Center dot
      overlayCtx.beginPath();
      overlayCtx.arc(cx, cy, 4, 0, 2 * Math.PI);
      overlayCtx.fill();
    });
  }
}

function updateGlucoseDisplay(glucose) {
  const value = parseFloat(glucose);
  currentGlucose = value;
  
  const isNormal = value >= 70 && value <= 140;
  
  out.className = isNormal ? 'glucose-normal' : 'glucose-abnormal';
  out.textContent = `${value.toFixed(1)} mg/dL`;
  
  status.style.display = 'block';
  if (isNormal) {
    status.className = 'status-normal';
    status.textContent = '✓ Normal Range (70-140 mg/dL)';
  } else {
    status.className = 'status-abnormal';
    if (value < 70) {
      status.textContent = '⚠ Below Normal Range (Low)';
    } else {
      status.textContent = '⚠ Above Normal Range (High)';
    }
  }
  
  addGlucoseReading(value);
}

async function startCam() {
  const stream = await navigator.mediaDevices.getUserMedia({ 
    video: { width: 640, height: 480 }, 
    audio: false 
  });
  video.srcObject = stream;
  
  // Wait for video to be ready and resize canvas
  await new Promise(resolve => {
    video.onloadedmetadata = () => {
      video.play();
      resizeCanvas();
      resolve();
    };
  });
}

function frameToBlob() {
  captureCtx.drawImage(video, 0, 0, 224, 224);
  return new Promise(res => capture.toBlob(b => res(b), 'image/jpeg', 0.9));
}

async function sendFrame() {
  try {
    const blob = await frameToBlob();
    const fd = new FormData();
    fd.append('file', new File([blob], 'frame.jpg', { type: 'image/jpeg' }));
    
    const r = await fetch(API, { method: 'POST', body: fd });
    
    if (!r.ok) {
      throw new Error(`Server error: ${r.status}`);
    }
    
    const j = await r.json();
    
    if (j.estimate_mg_dl !== null && j.eyes && j.eyes.length === 2) {
      // Valid prediction with both eyes
      currentEyes = j.eyes;
      updateGlucoseDisplay(j.estimate_mg_dl);
      msg.textContent = 'Both eyes detected ✓';
      msg.style.color = '#22c55e';
      drawEyeBoxes();
    } else {
      // Eyes closed or not detected
      currentEyes = [];
      out.textContent = '—';
      status.style.display = 'none';
      msg.textContent = 'Eyes closed or not detected - no prediction';
      msg.style.color = '#ef4444';
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
    }
  } catch (e) {
    msg.textContent = e.message;
    msg.style.color = '#ef4444';
    out.textContent = '—';
    status.style.display = 'none';
    currentEyes = [];
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  }
}

startBtn.onclick = async () => {
  startBtn.disabled = true; 
  stopBtn.disabled = false;
  await startCam();
  timer = setInterval(sendFrame, 1000);
};

stopBtn.onclick = () => {
  startBtn.disabled = false; 
  stopBtn.disabled = true;
  if (timer) clearInterval(timer);
  const s = video.srcObject;
  if (s) s.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  currentGlucose = null;
  currentEyes = [];
  out.textContent = '—';
  msg.textContent = '';
  msg.style.color = '#666';
  status.style.display = 'none';
};

window.addEventListener('load', () => {
  initChart();
});
</script>
</body>
</html>