<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EyeBloodGlucose — Live Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    #panel { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
    #videoContainer { position: relative; width: 640px; height: 480px; }
    video { border: 2px solid #ddd; border-radius: 8px; width: 100%; height: 100%; }
    #overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none;
    }
    button { padding: 8px 12px; margin-top: 10px; }
    .glucose-normal { color: #22c55e; font-weight: bold; }
    .glucose-abnormal { color: #ef4444; font-weight: bold; }
    #status { 
      padding: 8px 12px; 
      border-radius: 6px; 
      margin-top: 8px;
      font-size: 14px;
    }
    .status-normal { 
      background-color: #dcfce7; 
      color: #166534;
      border: 2px solid #22c55e;
    }
    .status-abnormal { 
      background-color: #fee2e2; 
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    canvas { display: none; }
  </style>
</head>
<body>
  <h2>EyeBloodGlucose — Real-Time Demo</h2>
  <p>Real-time webcam prototype with live eye detection — not medical advice.</p>

  <div id="panel">
    <div>
      <div id="videoContainer">
        <video id="video" width="640" height="480" autoplay muted playsinline></video>
        <canvas id="overlay" width="640" height="480"></canvas>
      </div>
      <button id="start">Start</button>
      <button id="stop" disabled>Stop</button>
      <div style="margin-top:8px;color:#666">Analyzing eyes in real-time</div>
    </div>

    <div style="min-width:280px">
      <div style="padding:12px;border:1px solid #eee;border-radius:8px">
        <div><strong>Predicted glucose:</strong></div>
        <div id="out" style="font-size:32px;margin-top:6px">—</div>
        <div id="status" style="display:none;"></div>
        <div id="msg" style="font-size:12px;color:#666;margin-top:6px"></div>
      </div>
    </div>
  </div>

<canvas id="capture" width="224" height="224"></canvas>

<script>
const API = "https://eyebloodglucose.onrender.com/predict";
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
const capture = document.getElementById('capture');
const captureCtx = capture.getContext('2d');
const out = document.getElementById('out');
const msg = document.getElementById('msg');
const status = document.getElementById('status');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');

let timer = null;
let currentGlucose = null;

function drawEyeBoxes() {
  // Clear previous overlay
  overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  
  if (!currentGlucose) return;
  
  // Determine color based on glucose level
  const isNormal = currentGlucose >= 70 && currentGlucose <= 140;
  const color = isNormal ? '#22c55e' : '#ef4444';
  
  // Draw detection indicator (simulated - we'll draw a frame border for now)
  // In a full implementation, the backend would return eye coordinates
  overlayCtx.strokeStyle = color;
  overlayCtx.lineWidth = 4;
  overlayCtx.strokeRect(0, 0, overlay.width, overlay.height);
  
  // Add "DETECTING" text
  overlayCtx.fillStyle = color;
  overlayCtx.font = 'bold 16px system-ui';
  overlayCtx.fillText('● ANALYZING EYES', 10, 30);
}

function updateGlucoseDisplay(glucose) {
  const value = parseFloat(glucose);
  currentGlucose = value;
  
  // Check if in normal range (70-140 mg/dL)
  const isNormal = value >= 70 && value <= 140;
  
  // Update glucose number with color
  out.className = isNormal ? 'glucose-normal' : 'glucose-abnormal';
  out.textContent = `${value.toFixed(1)} mg/dL`;
  
  // Show status message
  status.style.display = 'block';
  if (isNormal) {
    status.className = 'status-normal';
    status.textContent = '✓ Normal Range (70-140 mg/dL)';
  } else {
    status.className = 'status-abnormal';
    if (value < 70) {
      status.textContent = '⚠ Below Normal Range (Low)';
    } else {
      status.textContent = '⚠ Above Normal Range (High)';
    }
  }
  
  // Update overlay
  drawEyeBoxes();
}

async function startCam() {
  const stream = await navigator.mediaDevices.getUserMedia({ 
    video: { width: 640, height: 480 }, 
    audio: false 
  });
  video.srcObject = stream;
}

function frameToBlob() {
  captureCtx.drawImage(video, 0, 0, 224, 224);
  return new Promise(res => capture.toBlob(b => res(b), 'image/jpeg', 0.9));
}

async function sendFrame() {
  try {
    const blob = await frameToBlob();
    const fd = new FormData();
    fd.append('file', new File([blob], 'frame.jpg', { type: 'image/jpeg' }));
    
    const r = await fetch(API, { method: 'POST', body: fd });
    
    if (!r.ok) {
      throw new Error(`Server error: ${r.status}`);
    }
    
    const j = await r.json();
    updateGlucoseDisplay(j.estimate_mg_dl);
    msg.textContent = `Mode: ${j.mode || 'detecting'}`;
  } catch (e) {
    msg.textContent = e.message;
    out.textContent = '—';
    status.style.display = 'none';
    currentGlucose = null;
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  }
}

startBtn.onclick = async () => {
  startBtn.disabled = true; 
  stopBtn.disabled = false;
  await startCam();
  timer = setInterval(sendFrame, 1000);
};

stopBtn.onclick = () => {
  startBtn.disabled = false; 
  stopBtn.disabled = true;
  if (timer) clearInterval(timer);
  const s = video.srcObject;
  if (s) s.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  currentGlucose = null;
  out.textContent = '—';
  msg.textContent = '';
  status.style.display = 'none';
};
</script>
</body>
</html>